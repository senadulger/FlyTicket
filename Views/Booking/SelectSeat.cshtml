@model List<prgmlab3.Models.SeatModel>

@{
    // Sayfa başlığı
    ViewData["Title"] = "Koltuk Seçimi";

    // ViewBag üzerinden gelen uçuş ve yardımcı veriler
    var flight = ViewBag.Flight as prgmlab3.Models.FlightModel; // Seçilen uçuş bilgisi
    var planeName = ViewBag.PlaneName as string; // Uçak adı
    var reservedIds = ViewBag.ReservedSeatIds as List<int> ?? new List<int>(); // Dolu koltuk ID listesi
    var airportMap = ViewBag.AirportMap as Dictionary<int, string>; // AirportId -> "Şehir (KOD)" map
}

<div class="container mt-1">

    <!-- Uçuş bilgileri kartı -->
    <div class="flight-info-card">
        <h4 class="flight-info-title">Uçuş Bilgileri</h4>

        <!-- Uçuş detayları -->
        <div class="flight-info-text">
            <div><strong>Uçak:</strong> @planeName</div>

            <!-- Kalkış bilgisi: Havaalanı adı ve tarih/saat -->
            <div>
                <strong>Kalkış:</strong>
                @airportMap?[flight.DepartureLocation] - @flight.DepartureTime.ToString("dd.MM.yyyy HH:mm")
            </div>

            <!-- Varış bilgisi -->
            <div>
                <strong>Varış:</strong>
                @airportMap?[flight.ArrivalLocation] - @flight.ArrivalTime.ToString("dd.MM.yyyy HH:mm")
            </div>

            <!-- Dinamik fiyat: koltuk sınıfı seçimine göre JS ile güncellenir -->
            <div>
                <strong>Fiyat:</strong> <span id="dynamic-price">@flight.Price</span> ₺
            </div>
        </div>
    </div>

    <!-- Hata mesajı -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger mb-4">@TempData["Error"]</div>
    }

    <!-- Kupon alanı -->
    <div class="row mb-1">
        <div class="col-md-4">
            <div class="coupon-card">
                <h5 class="fw-bold mb-3" style="color: #1f2937;">Kupon Kodu</h5>

                <!-- Kupon uygulama formu (GET): aynı sayfaya couponCode ile döner -->
                <form method="get" asp-action="SelectSeat" class="d-flex align-items-center">
                    <!-- Aynı uçuşta kalmak için flightId tekrar gönderilir -->
                    <input type="hidden" name="flightId" value="@flight.Id" />

                    <!-- Kupon kodu inputu (önceki değer ViewBag'den basılır) -->
                    <input type="text" name="couponCode" value="@ViewBag.CouponCode"
                        class="form-control form-control-lg me-3" placeholder="Kupon Kodu"
                        style="background-color: #f9fafb;" />

                    <button type="submit" class="btn btn-primary btn-lg" style="min-width: 120px;">Uygula</button>
                </form>

                <!-- Kupon mesajı (geçerli/geçersiz) -->
                @if (ViewBag.CouponMessage != null)
                {
                    <div class="mt-3 fw-bold text-@(ViewBag.IsCouponValid == true ? "success" : "danger")">
                        @ViewBag.CouponMessage
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Koltuk seçimi başlığı -->
    <h3 class="section-title mt-2">Koltuk Seçimi</h3>

    <!-- Koltuk grid alanı -->
    <div class="row g-0 gx-1 gy-1">

        @* Koltuklar SeatNumber’a göre sıralanarak ekrana basılır *@
        @foreach (var seat in Model.OrderBy(s => int.TryParse(s.SeatNumber, out int n) ? n : int.MaxValue).ThenBy(s => s.SeatNumber))
        {
            // Koltuk dolu mu?
            var isReserved = reservedIds.Contains(seat.Id);

            // Buton sınıfı ve yazısı doluluğa göre değişir
            var btnClass = isReserved ? "btn-seat-occupied" : "btn-seat-select";
            var btnText = isReserved ? "Dolu" : "Seç";

            // Koltuk sınıfı (1: Business, 0: Economy)
            var seatClass = seat.Class == 1 ? "Business" : "Economy";

            // Koltuk fiyatı: sınıfa göre ViewBag'den gelir
            var seatPrice = (seat.Class == 1) ? ViewBag.PriceBusiness : ViewBag.PriceEconomy;

            <div class="col-md-2 col-sm-3 col-4">

                <!-- Koltuk kartı: doluysa occupied class eklenir -->
                <div class="seat-card @(isReserved ? "occupied" : "")" @* Dolu değilse karta tıklayınca JS ile fiyat güncellenir ve kart vurgulanır *@
              onclick="@(isReserved ? "" : $"selectSeat(this, '{seatPrice}')")">

                    <div class="card-body">
                        <!-- Koltuk numarası -->
                        <div class="seat-number">@seat.SeatNumber</div>

                        <!-- Koltuk sınıfı -->
                        <div class="seat-class">@seatClass</div>

                        @if (isReserved)
                        {
                            <!-- Dolu koltuk: seçim kapalı -->
                            <button class="btn-seat-occupied" disabled>Dolu</button>
                        }
                        else
                        {
                            <!-- Rezerve etme formu (POST) -->
                            <form asp-action="BookSeat" method="post" class="w-100">
                                @Html.AntiForgeryToken()

                                <!-- Rezervasyon için gerekli bilgiler -->
                                <input type="hidden" name="flightId" value="@flight.Id" />
                                <input type="hidden" name="seatId" value="@seat.Id" />

                                <!-- Kupon kodu rezervasyon sırasında da gönderilir -->
                                <input type="hidden" name="couponCode" value="@ViewBag.CouponCode" />

                                <!-- Seç butonu: kullanıcıdan onay alır -->
                                <button type="submit" class="btn-seat-select"
                                    onclick="return confirm('@seat.SeatNumber numaralı koltuğu rezerve etmek istiyor musunuz?');">
                                    Seç
                                </button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Basit JS: Kart seçimi ve fiyatın ekranda güncellenmesi -->
    <script>
        // Kart tıklanınca fiyatı günceller ve seçilen kartı vurgular
        function selectSeat(element, price) {
            // Üstteki fiyat alanını güncelle
            var el = document.getElementById('dynamic-price');
            if (el) {
                el.innerText = price;
            }

            // Tüm kartlardan önceki seçimi kaldır
            var allCards = document.querySelectorAll('.seat-card');
            allCards.forEach(function (card) {
                card.classList.remove('border-primary', 'border-3');
            });

            // Seçilen karta vurgu ekle
            element.classList.add('border-primary', 'border-3');
        }
    </script>
</div>